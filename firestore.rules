/**
 * @fileoverview Firestore Security Rules for CheckersVerse.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model for user accounts and profiles,
 * and a shared access model for friendships and game sessions.
 *
 * Data Structure:
 * - /users/{userId}: User account information, owned by the user.
 * - /users/{userId}/profile: User profile information, owned by the user.
 * - /friendships/{friendshipId}: Friendship relationships, accessible to the two users involved.
 * - /game_sessions/{gameSessionId}: Game session data, accessible to the two players involved.
 * - /game_sessions/{gameSessionId}/messages/{messageId}: Chat messages within a game session, accessible to the two players involved in the game.
 *
 * Key Security Decisions:
 * - Users can only access their own account and profile data.
 * - Friendships are accessible to the two users involved.
 * - Game sessions and associated messages are accessible to the two players involved.
 * - Data validation is minimal in this prototyping phase, focusing on ownership and relationship integrity.
 *
 * Denormalization for Authorization:
 * - The /friendships/{friendshipId} document includes a `members` map containing the user IDs of the two users in the friendship.
 * - The /game_sessions/{gameSessionId} document includes a `members` map containing the user IDs of the two players in the game.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Users can only read/write their own data
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;

      match /profile/{profileId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
    }
    
    // Counter for numeric IDs can be updated by any authenticated user
    match /metadata/userCounter {
      allow read, write: if request.auth != null;
    }

    // Friendships can be read by members, created by anyone, and updated/deleted by members.
    match /friendships/{friendshipId} {
      allow read, update, delete: if request.auth != null && resource.data.members[request.auth.uid] == true;
      allow create: if request.auth != null;
      allow list: if request.auth != null;
    }
    
    // Game sessions can be managed by members.
    match /game_sessions/{gameSessionId} {
      allow create: if request.auth != null;
      allow read, update, delete: if request.auth != null && resource.data.members[request.auth.uid] == true;
      allow list: if request.auth != null && request.query.where.get('members.' + request.auth.uid, false) == true;

       // Messages can be accessed by game members.
      match /messages/{messageId} {
        allow read, write: if request.auth != null && get(/databases/$(database)/documents/game_sessions/$(gameSessionId)).data.members[request.auth.uid] == true;
      }
    }
  }
}
